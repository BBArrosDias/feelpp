#! /bin/bash

set -eo pipefail
set -x


# default values
FEELPP_BRANCH=develop
DIST=${1:-focal}
FLAVOR=${2:-ubuntu}

if [ -d ../build-$DIST ]; then rm -rf ../build-$DIST; fi
#git clone https://github.com/feelpp/feelpp /tmp/feelpp
mkdir ../build-$DIST
cd ../build-$DIST && ../feelpp/configure -r --enable-toolboxes --enable-mor --cmakeflags="-DFEELPP_ENABLE_GIT=OFF -DLIBBSON_DIR=/usr -DLIBMONGOC_DIR=/usr"
make package_source
git clone https://github.com/feelpp/feelpp.pkg.git
main_version=$(echo feelpp-*.tar.gz | sed -E 's/feelpp-(.*)-(.*).tar.gz/\1/g' )
version=$(echo feelpp-*.tar.gz | sed -E 's/feelpp-(.*)-(.*).tar.gz/\1~\2/g' )
rename_archive=$(echo feelpp-*.tar.gz | sed -E 's/feelpp-(.*)-(.*).tar.gz/feelpp_\1~\2.orig.tar.gz/g' )
cp feelpp-*.tar.gz feelpp.pkg/feelpp/$rename_archive
cd feelpp.pkg/feelpp/$DIST && tar xzvf ../$rename_archive --strip 1

dch -v "$version-1" --distribution "unstable" -b "New upstream commits"
dpkg-source -b .
pbuilder-dist $DIST build ../feelpp_${version}-1.dsc
../upload_bintray.sh $main_version $HOME/pbuilder/${DIST}_result $FLAVOR $DIST

