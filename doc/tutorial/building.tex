\chapter{Building and Programming Environment}


\section{Building Feel}
\subsection{Getting the source via an archive}
\label{sec:getting-source-via-1}

\feel is distributed as a tarball once in a while. The tarballs are available
at
\begin{center}
  \href{http://www.feelpp.org/files}{http://www.feelpp.org/files}
\end{center}
Download the latest tarball. Then follow the steps and replace
\texttt{x},\texttt{y},\texttt{z} with the corresponding numbers

\begin{unixcom}
  tar xzf feel-x.y.z.tar.gz
  cd feel-x.y.z
\end{unixcom}


\subsection{Getting the source via Subversion}
\label{sec:getting-source-via}
In order to download the sources of \feel, you can download it directly from the source depository thanks to Subversion. To make it possible, you can download them anonymously or with an account in LJKForge that you have created. As an open-source project, we strongly suggest you to create an account and take part of the project with sharing your ideas, developments or suggests. If you're interested to participate and become a \feel++ developer, please don't hesitate to see how it works in the appendix ~\ref{feeldevel}. For now, if you want to get the sources without an account, open a command-line and type
\begin{unixcom}
		svn checkout svn://scm.forge.imag.fr/var/lib/gforge/chroot/scmrepos/svn/life/trunk/life/trunk feel
\end{unixcom}
then you can go to the \feel top directory with
\begin{unixcom}
		cd feel
\end{unixcom} 
You should obtain furthers directories such as :
\begin{lstlisting}[language=sh]
applications/   # functional applications
benchmarks/  # applications under test
cmake/   # do not touch, used for compilation
contrib/
doc/   # tutorial and examples of it
examples/
feel/   # heart of the library
ports/   # used for Mac OS X installation
research/   # current research, not important now 
testsuite/   
CMakeListe.txt   # the file for cmake to build, do not modify
...
\end{lstlisting} 

\subsection{Unix : dependencies}
\label{sec:about-dependencies}

In order to install \feel on Unix systems (other than Mac OS X, in you have a Macintosh, please go to ~\ref{macosx}), you have to install many dependencies
before. Those libraries and programs are necessary for the
compilation and installation of the \feel librairies.
This is the list of all the librairies you must have installed on your
computer, and the \verb|*-dev| packages for some of them. 
\newline\newline
\underline{Required packages}:
\begin{itemize}
\item g++ ($4.4$ or $4.5$, from now $4.6$ is not yet	completely working  )
\item MPI : openmpi (preferred) or mpich
\item Boost ($\geq$1.39)
\item Petsc ($\geq$2.3.3)
\item Cmake ($\geq$2.6)
\item Gmsh\footnote{Gmsh is a pre/post processing software for scientific
computing available at \url{http://www.geuz.org/gmsh}}
\item Libxml2
\end{itemize}
\underline{Optional packages}:
\begin{itemize}
\item Superlu
\item Suitesparse(umfpack)
\item Metis: scoth with the metis interface (preferred), metis (non-free)
\item Trilinos ($\geq$8.0.8)
\item Google perftools
\item Paraview\footnote{Paraview is a few parallel scientific data
    visualisation plateform, \url{http://www.paraview.org}}, this is
  not stricly required to run \feel programs but it is somehow
  necessary for visualisation
\item Python ($\geq$ 2.5) for the validation tools
\end{itemize}
Note that all these packages are available under Debian/GNU/Linux and
Ubuntu. They should be available. Once you have installed those dependencies, you can jump to ~\ref{compilingfeel}.

\subsection{Mac OS X installation}
\label{macosx}
\feel is also working on Mac operating systems. The way to make it work is quiet different.
\subsubsection{Compilers}
In order to \feel and \cmake work properly, you have to install differents compilers :
\begin{itemize}
\item Gcc \newline
The first step is to install the latest version of Xcode. If your computer is recent, you can install it with your DVD that came with your machine (not the OS DVD, but the applications one). You don't have to install the complete Xcode (you can uncheck iOS SDK for example, it's not necessary here and requiers a lot of memory). Xcode will provide your computer all basic tools to compile such as gcc 4.2. It's the first step, you'll see later how to easily install gcc 4.5 using MacPorts.
\item Fortran \newline
To build the Makefiles, \cmake will need a Fortran compiler. To make it works, please go to \href{http://hpc.sourceforge.net/}{SourceForge.net} and download \verb|gfortran-snwleo-intel-bin.tar.gz| which is the fortran compiler only (from now, don't download the complete install with gcc 4.6 because Feel needs gcc 4.5). To install it, go to the directory where you have downloaded the file and type in a command-line : 
\begin{unixcom}
		sudo tar -xvf gfortran-snwleo-intel-bin.tar -C /
\end{unixcom}

\end{itemize}

\subsubsection{MacPorts}

\paragraph{Introduction} 
MacPorts is an open-source community projet which aims to design an easy-to-use system for compiling, installing and upgrading open-source softwares on Mac OS X operating system. It is distributed under \href{http://opensource.org/licenses/bsd-license.php}{BSD License} and facilitate the access to thousands of ports (softwares) without installing or compiling open-source softwares. \newline \newline
MacPorts provides a single software tree which includes the latest stable releases of approximately 8050 ports targeting the current Mac OS X release (10.6 or 10.5). If you want more information, please visite their \href{http://www.macports.org/}{website}.

\paragraph{Installation}
To install the latest version of MacPorts, please go to \href{http://www.macports.org/install.php}{Installing MacPorts} page and follow the instructions. The simplest way is to download the $dmg$ disk image corresponding to your version of Mac OS X. It is recommended that you install X11 (X Window System) which is normally used to display X11 applications.%, and also the Xcode Tools (only the developer tools, iOS SDK is not required). 
\newline \newline
If you have installed with the package installer (\verb|MacPorts-1.x.x.dmg|) that means MacPorts will be installed in \verb|/opt/local|. From now on we will suppose that macports has been installed in \verb|/opt/local| which is the default MacPorts location. %At the end of the installation, you can check if your PATH has been upgraded by the command \verb|echo $PATH| which should return a line containing \verb|/opt/local/bin:/opt/local/sbin|.

\paragraph{Key commands}
In your command-line, the software MacPorts is called by the command \verb|port|. 
Here is a list of key commands for using MacPorts, if you want more informations please go to \href{http://guide.macports.org/#using.port}{MacPorts Commands}.
\begin{itemize}
\item \verb|sudo port -v selfupdate| \newline
	This action should be used regularly to update the local tree with the global MacPorts ports. The option \verb|-v| enables verbose which generates verbose messages.
\item \verb|port info flowd| \newline
	This action is used to get information about a port (description, license, maintainer, etc.)
\item \verb|sudo port install mypackage| \newline
	This action install the port mypackage
\item \verb|sudo port uninstall mypackage| \newline
	This action uninstall the port mypackage
\item \verb|port installed| \newline
	This action displays all ports installed and their versions, variants and activation status. You can also use the \verb|-v| option to also display the platform and CPU architecture(s) for which the ports were built, and any variants which were explicitly negated.
\item \verb|sudo port upgrade mypackage| \newline
	This action updgrades installed ports and their dependencies when a \verb|Portfile| in the repository has been updated. To avoid the upgrade of a port's dependencies, use the option \verb|-n|.
\end{itemize}

\paragraph{Portfile}
A Portfile is a TCL script which usually contains simple keyword values and TCL expressions. Each package/port has a corresponding Portfile but it's only a part of a port description.
Feel++ provides some mandatory Portfiles for its compilation which are either not available in MacPorts or are buggy but Feel++ also provides some Portfiles which are already available in MacPorts such as gmsh or petsc. They usually provide either some fixes to ensure Feel++ works properly or new version not yet available in MacPorts. \newline \newline
These Portfiles are installed in \verb|ports/macosx/macports|.

\subsubsection{MacPorts and Feel}


To be able to install feel++, add the following line in \verb|/opt/local/etc/macports/source.conf|
at the top of the file before any other sources :
\begin{lstlisting}[language=sh]
file:///<path to feel++ top directory>/ports/macosx/macports
\end{lstlisting} 

Once it's done, go to \verb|<path to feel++ top directory>/ports/macosx/macports| and type in a command-line :
\begin{unixcom}
		cd <your path to feel top directory>/ports/macosx/macports 
		portindex
\end{unixcom}

You should have an output like this : 
\begin{flushleft}
\fbox{
   \begin{minipage}{0.81\textwidth}
      	Reading port index in $<$your path to feel top directory$>$/ports/macosx/macports\\
	Adding port science/feel++ \\
	Adding port science/gmsh \\
	Adding port science/petsc \\ \\
	Total number of ports parsed:   3\\
	Ports successfully parsed:      3\\
	Ports failed:                   0\\
	Up-to-date ports skipped:       0
   \end{minipage}
}
\end{flushleft}
Your are now able to type 
\begin{unixcom}
		sudo port install feel++
\end{unixcom}
It might take some time (possibly an entire day) to compile all the requirements for Feel++
to compile properly. If you have several cores on your MacBook Pro, iMac or MacBook
we suggest that you configure macports to use all or some of them.
To do that uncomment the following line in the file \newline \verb|/opt/local/etc/macports/macports.conf|
\begin{flushleft}
\begin{lstlisting}[language=sh]
buildmakejobs	0 $\#$ all the cores
\end{lstlisting} 
\end{flushleft}
At the end of the \verb|sudo port install feel++|, you have all dependencies installed which is a good point. To build all the Makefile, \cmake is automatically launched but can have furthers libraries not found. Some are important, some are not. OpenMP is one of the necessary compiler to have and is not automatically installed on 64bits systems. We can install it now thanks to gcc4.5 that has been installed because it taks part of the feel dependencies. To install it, please go to \href{http://www.hpcs.cs.tsukuba.ac.jp/omni-openmp/download/download-omni.html}{Omni download} and download the latest stable release. Then type
\begin{unixcom}
		tar -xvf Omni-x.yz.tar.gz 
		cd  Omni-x.yz
		./configure --with-cc=/opt/local/bin/gcc-mp-4.5
		make
\end{unixcom}
Then, you have to become a super-user so type
\begin{unixcom}
		sudo su
\end{unixcom}
Enter your password, then to complete the installation 
\begin{unixcom}
		make install
\end{unixcom}
After the install is complete, you can delete the sources in your download directory because make install has built it in an appropriate directory. To make it work properly, always check that \cmake is using gcc 4.5. If \cmake doesn't recognize openMP, enter the configuration mode using \ccmake and enter \verb|-fopenmp| in the box \verb|OpenMP_CXX_FLAGS|

\subsubsection{Issues with slepc or petsc}
We have heard about issues with petsc and slepc with some new MacBook Pro while they are being installed with the \verb|sudo port install feel++|. If it's the case, you should do 
\begin{unixcom}
		cd <path to feel top directory>/ports/macosx/macports
		portindex -f
\end{unixcom}

then type in the exact same order :
\begin{unixcom}
		sudo port uninstall slepc 
		sudo port uninstall petsc
		sudo port install -d petsc
		sudo port install slepc
\end{unixcom}
and type once again
\begin{unixcom}
		sudo port install feel++
\end{unixcom}
%%%% A voir avec Stéphane si ça a bien réussi 

\subsubsection{Missing ports}
\cmake can build Makefiles even if some packages are missing (latex2html, VTK ...). It's not necessary to install them but you can complete the installation with MacPorts, \cmake will find them by itself once they have been installed.

\subsection{Compiling Feel}
\label{compilingfeel}
Feel build system uses \cmake\index{cmake}\footnote{\url{http://www.cmake.org}}
as its build system. Check that \cmake is using gcc4.5 or 4.4 as C++ compiler
(you can use the option \verb|CMAKE_CXX_COMPILER=<path>/g++-4.5| where the
\verb|path| depends on your OS, it's probably \verb|/usr/bin| or
\verb|/opt/local/bin| but you can also change it with the command \verb|ccmake|
and press \verb|t| for advanced options). \newline It's important, as \cmake did
not produce any Makefile, a CMakeCache.txt won't be created so you'll have to
check each time that gcc 4.5 is the C++ compiler to be sure the build will be
correct.\newline

\feel, using \cmake, can be built either in source and out of source and different
build type:
\begin{itemize}
\item minsizerel : minimal size release
\item release release
\item debug : debug
\item none(default)
\end{itemize}

\paragraph{CMake Out Source Build (preferred)}
The best way is to have a directory (\verb|FEEL| for example) in which you have : \\
\begin{lstlisting}
	feel/
\end{lstlisting}
where \verb|feel| is the top directory where the source have been downloaded. Placed in \verb|FEEL|, you can create the build directory (\verb|feel.opt| for example) and lauch cmake with :
\begin{unixcom}
  mkdir feel.opt
  cd feel.opt
  cmake <directory where the feel source are>
  # e.g cmake ../feel if feel.opt is at the same
  # directory level as feel
\end{unixcom}
you can customize the build type:
\begin{unixcom}
  # Choose g++ release
  cmake -CMAKE_CXX_COMPILER=/usr/bin/g++-4.5
  # Debug build type (-g...)
  cmake -D CMAKE_BUILD_TYPE=Debug
  # Release build type (-O3...)
  cmake -D CMAKE_BUILD_TYPE=Release
  ...
\end{unixcom}
Once Cmake has made its work, you are now able to compile the library with
\begin{unixcom}
		make
\end{unixcom}
\textbf{Important :} from now, all commands should be type in \verb|feel.opt| or its subdirectories.
\paragraph{CMake In Source Build}

Be carefull, this is not advised and if you try this way, \cmake won't let you do. If you really want to, you will have to modifiy the top \verb|CMakeLists.txt|. You should consider out source builds by checking the next paragraph.

Enter the source tree and type
\begin{unixcom}
  cmake .
  make
\end{unixcom}

To customize or change some build setting one can use the \cmake curse interface
\ccmake
\begin{unixcom}
  ccmake . # configure and generate
  make
\end{unixcom}


% \subsection{Compiling Feel with the AutoTools}

% Go in the same folder in wich you have done the checkout and type the following
% commands :

% \subsubsection{From tarball}
% \label{sec:from-tarball}

% The steps are as follows to configure the \feel Development Plateform

% \begin{unixcom}
%   cd feel-x.y.z
%   mkdir opt
%   cd opt

%   ../configure --enable-opt2
% \end{unixcom}

% Then type
% \begin{unixcom}
%   make
% \end{unixcom}

% to compile the library and the tutorial. And finally type
% \begin{unixcom}
%   make check
% \end{unixcom}
% In order to compile the testsuite, the examples and the benchmarks and
% execute some of them to verity that the \feel library is functional.


% \subsubsection{From subversion}
% \label{sec:from-subversion}

% The steps are as follows to configure the \feel Development Plateform

% \begin{unixcom}
%   cd feel
%   make -f Makefile.dist
%   mkdir opt
%   cd opt

%   ../configure --enable-opt2
% \end{unixcom}

% Then, to build  the \feel library, type
% \begin{unixcom}
%   make
% \end{unixcom}

% And finally to check the library, type
% \begin{unixcom}
%   make check
% \end{unixcom}


% \begin{note}
%   The script \lstinline!configure! supports many command line
%   options. In particular if you are interested in writing some code or
%   examples inside the \feel environment you have to enable the so
%   called \emph{maintainer mode} to ensure that the makefiles are
%   properly regenerated when you modify a \lstinline!Makefile.am! or if
%   you modify \lstinline!configure.ac!, to achieve this type
%   \begin{unixcom}
%     configure --enable-maintainer-mode
%   \end{unixcom}
%   To list all configure options, type
%   \begin{unixcom}
%     configure --help
%   \end{unixcom}
% \end{note}


% \subsubsection{Compiling an extra module}
% \label{sec:compile-an-extra}

% If you work with an extra module, \emph{e.g.} \lstinline!validation!, the steps are as follows
% \begin{unixcom}
% cd feel
% make -f Makefile.dist
% cd benchmarks/validation
% make -f Makefile.dist
% cd ../../..
% mkdir opt
% cd opt
% ../feel/configure --enable-opt2 --enable-maintainer-mode
% make
% make check
% \end{unixcom}


\subsubsection{Compiling the Feel tutorial}
\label{sec:comp-feel-tutor}
If the command \verb|make check| in \verb|feel.opt/| has been run before the tutorial
should be already compiled and ready. The steps are as follows  to build the Feel tutorial
\begin{unixcom}
  cd feel.opt/doc/tutorial
  make pdf
\end{unixcom}
%Here is what the directory should look like
%\begin{unixcom}
%  cd opt/doc/tutorial
%  ls
%
%  laplacian     Makefile      myintegrals   mymesh       pngs/
%  tutorial.blg  tutorial.out  tutorial.toc  laplacian.o  myapp
%  myintegrals.o mymesh.o      stokes.assert tutorial.aux pdfs/ styles/
%  stokes        stokes.o      tutorial.bbl  tutorial.log tutorial.pdf
%\end{unixcom}
The directory \verb|doc/tutorial| contains all examples used in the tutorial. You will see how it works in the following parts.

\section{Programming environment}
\label{sec:progr-envir}
We present here a quick list of all namespaces and librairies proposed by \feel, you'll see in the tutorial which starts at section ~\ref{sec:tutorial} how you can use them.
\subsection{Boost C++ Libraries}
\label{sec:boost-c++-libraries}

\feel depends on a number of libraries, some are required some are optional.
Among the required libraries, The Boost C++ libraries play a very important role
as they drive or shape the  design of \feel. \feel uses in particular the
following Boost libraries:
\begin{itemize}
\item Boost.Parameter\index{Boost!Parameter} : use to provide powerful
  interfaces to \feel and third party library such as 
  \begin{itemize}
  \item PETSc  for the linear, nonlinear solvers
  \item SLEPc for the eigenvalue solvers
  \item GMSH for mesh generation
  \end{itemize}
\item Boost.MPL - meta programming library : use for type computations
\item Boost.Fusion - linking meta-runtime programming: use for type computations
  used at runtime
\item Boost.Program\_Options - command-line options library : provides the
  command line options for the \feel applications as well as configuration files
\item Boost.Test - Unit testing framework ; used by the \feel testsuite
\end{itemize}

\subsection{\feel Namepaces}

\begin{itemize}
\item \lstinline!Feel!
\item \lstinline!Feel::po!
\item \lstinline!Feel::mpl!
\item \lstinline!Feel::ublas!
\item \lstinline!Feel::math!
\item \lstinline!Feel::fem!
\item \lstinline!Feel::vf!

\end{itemize}